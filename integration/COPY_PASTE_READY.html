<!-- 
  ============================================
  QUIZ FUNNEL INTEGRATION - COPY & PASTE READY
  ============================================
  
  INSTRUCTIONS:
  1. Replace YOUR_VERCEL_URL with your actual Vercel URL
  2. Replace your-quiz.com/next-step with your actual next quiz step URL
  3. Copy this entire block into your quiz funnel HTML
  4. Done! All UTM parameters are automatically tracked and preserved.
-->

<button 
  id="wallet-pass-btn" 
  class="wallet-pass-button"
  onclick="addToWalletAndContinue()"
>
  Add to Apple Wallet
</button>

<script>
async function addToWalletAndContinue() {
  // ⚠️ STEP 1: Replace with your Vercel URL
  const PASS_BASE_URL = 'https://YOUR_VERCEL_URL.vercel.app';
  
  // ⚠️ STEP 2: Replace with your next quiz step URL
  const nextStepUrl = 'https://your-quiz.com/next-step';
  
  // ✅ Automatically captures ALL URL parameters from current page
  // This includes: utm_source, utm_campaign, utm_medium, utm_term, utm_content, click_id, etc.
  const urlParams = new URLSearchParams(window.location.search);
  const clickId = urlParams.get('click_id') || generateClickId();
  
  // Build pass generation URL with all parameters
  const passUrl = new URL(`${PASS_BASE_URL}/api/generate-pass`);
  passUrl.searchParams.set('click_id', clickId);
  
  // Copy ALL query parameters to pass generation request
  // This ensures all UTM parameters are sent to the backend
  urlParams.forEach((value, key) => {
    if (key !== 'click_id') {
      passUrl.searchParams.set(key, value);
    }
  });
  
  // Update button state
  const button = document.getElementById('wallet-pass-btn');
  const originalText = button ? button.textContent : 'Add to Apple Wallet';
  if (button) {
    button.disabled = true;
    button.textContent = 'Opening Wallet...';
  }
  
  try {
    // Fetch the pass file
    const response = await fetch(passUrl.toString());
    
    if (!response.ok) {
      throw new Error(`Failed to generate pass: ${response.status}`);
    }
    
    // Convert to Blob and trigger Wallet sheet
    const blob = await response.blob();
    const objectUrl = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = objectUrl;
    link.download = 'pass.pkpass';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setTimeout(() => {
      window.URL.revokeObjectURL(objectUrl);
    }, 100);
    
    // ✅ Build redirect URL with ALL parameters preserved
    const redirectUrl = new URL(nextStepUrl);
    
    // Preserve ALL original query parameters in redirect
    // This ensures UTM parameters continue to the next step
    urlParams.forEach((value, key) => {
      redirectUrl.searchParams.set(key, value);
    });
    
    // Redirect after 1 second (allows time for Wallet to open)
    setTimeout(() => {
      window.location.href = redirectUrl.toString();
    }, 1000);
    
  } catch (error) {
    console.error('Error adding pass to wallet:', error);
    
    // Restore button on error
    if (button) {
      button.disabled = false;
      button.textContent = originalText;
    }
    
    alert('Failed to add pass to wallet. Please try again.');
  }
}

function generateClickId() {
  return 'click_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}
</script>

<style>
.wallet-pass-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 16px 32px;
  font-size: 18px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 300px;
}

.wallet-pass-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.wallet-pass-button:active:not(:disabled) {
  transform: translateY(0);
}

.wallet-pass-button:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
</style>

