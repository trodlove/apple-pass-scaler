<!-- 
  Apple Wallet Pass Integration - Frictionless HTML Button
  Copy this code into your quiz funnel where you want the "Add to Wallet" button
  
  This version uses the direct pass endpoint for minimal friction.
  User clicks button (consent) → Pass opens directly → Auto-redirects when user returns
-->

<!-- Replace YOUR_VERCEL_URL with your actual Vercel deployment URL -->
<!-- Example: https://apple-pass-scaler.vercel.app -->

<button 
  id="wallet-pass-btn" 
  class="wallet-pass-button"
  onclick="openWalletPass()"
>
  Add to Apple Wallet
</button>

<script>
// Auto-configured Vercel URL - ready to use!
const PASS_BASE_URL = 'https://apple-pass-scaler.vercel.app';

function openWalletPass() {
  
  // Get the next step URL (replace with your actual next quiz step)
  const nextStepUrl = 'https://your-quiz.com/next-step';
  
  // Get tracking parameters from current URL
  const urlParams = new URLSearchParams(window.location.search);
  const clickId = urlParams.get('click_id') || generateClickId();
  const utmSource = urlParams.get('utm_source') || '';
  const utmCampaign = urlParams.get('utm_campaign') || '';
  const utmMedium = urlParams.get('utm_medium') || '';
  
  // Build the pass generation URL using the page endpoint
  // This loads the pass in an iframe so we can detect when user returns
  const passUrl = new URL(`${PASS_BASE_URL}/api/issue-pass-page`);
  passUrl.searchParams.set('click_id', clickId);
  passUrl.searchParams.set('redirect_url', encodeURIComponent(nextStepUrl));
  
  // Preserve UTM parameters
  if (utmSource) passUrl.searchParams.set('utm_source', utmSource);
  if (utmCampaign) passUrl.searchParams.set('utm_campaign', utmCampaign);
  if (utmMedium) passUrl.searchParams.set('utm_medium', utmMedium);
  
  // Copy all other query parameters
  urlParams.forEach((value, key) => {
    if (!['click_id', 'redirect_url'].includes(key)) {
      passUrl.searchParams.set(key, value);
    }
  });
  
  // Show brief loading state (optional - can be removed for even faster flow)
  const button = document.getElementById('wallet-pass-btn');
  if (button) {
    const originalText = button.textContent;
    button.textContent = 'Opening Wallet...';
    button.disabled = true;
    
    // Navigate directly to pass file (no intermediate page)
    // This will open Wallet automatically
    window.location.href = passUrl.toString();
    
    // Fallback: restore button if navigation fails
    setTimeout(() => {
      if (button) {
        button.textContent = originalText;
        button.disabled = false;
      }
    }, 2000);
  } else {
    // If button not found, just navigate
    window.location.href = passUrl.toString();
  }
}

function generateClickId() {
  // Generate a unique click ID if not provided
  return 'click_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}
</script>

<style>
.wallet-pass-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 16px 32px;
  font-size: 18px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.wallet-pass-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.wallet-pass-button:active {
  transform: translateY(0);
}
</style>

